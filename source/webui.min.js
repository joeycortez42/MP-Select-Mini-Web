function pad(e,t){return s="000"+e,s.substr(s.length-t)}function scrollConsole(){$cont=$("#console"),$cont[0].scrollTop=$cont[0].scrollHeight}function feedback(e){return"Begin"==e.substring(0,5)||1==sdListing?(sdListing=!0,e.match(/End file list/g)&&(sdListing=!1),void buildFilnames(e)):(e=e.replace(/\n/g,"<br />"),void("T:"!=e.substring(0,2)&&("ok N0"==e.substring(0,5)&&(e="ok"),e=e.replace(/N0 P15 B13/g,""),e=e.replace(/N0 P15 B15/g,""),e=e.replace(/echo:/g,""),$("#gCodeLog").append('<p class="text-warning">'+e+"</p>"),scrollConsole())))}function sendCmd(e,t,n){void 0===n&&(n="code"),$("#gCodeLog").append('<p class="text-primary">'+e+' <span class="text-muted">; '+t+"</span></p>"),$.ajax({url:"set?"+n+"="+e,cache:!1}).done(),scrollConsole()}function initWebSocket(){url=window.location.hostname;try{ws=new WebSocket("ws://"+url+":81"),ws.onopen=function(){feedback("Connection Established")},ws.onmessage=function(e){feedback(e.data)},ws.onclose=function(){feedback("Disconnected")}}catch(e){feedback("Web Socket Error")}}function msToTime(e){var t=parseInt(e%1e3/100),n=parseInt(e/1e3%60),i=parseInt(e/6e4%60),s=parseInt(e/36e5%24);return s=s<10?"0"+s:s,i=i<10?"0"+i:i,n=n<10?"0"+n:n,s+":"+i+":"+n+"."+t}function start_p(){$("#stat").text("Printing"),sendCmd("M565","Start printing cache.gc")}function cancel_p(){$("#stat").text("Canceling"),sendCmd("{P:X}","Cancel print","cmd")}function printerStatus(){$.get("inquiry",function(e,t){$("#rde").text(e.match(/\d+/g)[0]),$("#rdp").text(e.match(/\d+/g)[2]),delaySyncTemperatures(e.match(/\d+/g)[1],e.match(/\d+/g)[3]);var n=e.charAt(e.length-1);"I"==n?($("#stat").text("Idle"),$("#pgs").css("width","0%"),$("#start_print").removeClass("btn-disable"),$(".movement button").removeClass("btn-disable"),$("#gCodeSend").removeClass("btn-disable")):"P"==n?($("#stat").text("Printing"),$("#pgs").css("width",e.match(/\d+/g)[4]+"%"),$("#pgs").html(e.match(/\d+/g)[4]+"% Complete"),$("#start_print").addClass("btn-disable"),$(".movement button").addClass("btn-disable"),$("#gCodeSend").addClass("btn-disable")):$("#stat").text("N/A")})}function startup(){"Printing"!=$("#stat").text()&&sendCmd("M563 S6","Enable faster Wi-Fi file uploads")}function delaySendTemp(e,t){clearTimeout(timers),timers=setTimeout(function(){compValue=pad(e,3),"extruder"==t&&sendCmd("{C:T0"+compValue+"}","Set extruder preheat to "+e+"°C","cmd"),"platform"==t&&sendCmd("{C:P"+compValue+"}","Set platform preheat to "+e+"°C","cmd")},250)}function delaySendSpeed(e){clearTimeout(timers),timers=setTimeout(function(){actualSpeed=Math.floor(255*(e/100)),sendCmd("M106 S"+actualSpeed,"Set fan speed to "+e+"%")},250)}function delaySyncTemperatures(e,t){clearTimeout(timers),timers=setTimeout(function(){$("#wre").is(":focus")||$("#wre").val(e),$("#wrp").is(":focus")||$("#wrp").val(t)},3e3)}function refreshSD(){0==initSDCard&&(sendCmd("M21","Initialize SD card"),initSDCard=!0),sendCmd("M20","List SD card files"),window.sdFilenames=[],$(".sd-files ul").html("")}function printFile(e){sendCmd("M23 "+e,"Select file"),setTimeout(function(){sendCmd("M24","Print file")},1e3),$("#stat").text("Printing"),$("#pgs").css("width","0%"),$("#pgs").html("0% Complete"),$("#start_print").addClass("btn-disable"),$(".movement button").addClass("btn-disable"),$("#gCodeSend").addClass("btn-disable")}function deleteFile(e){sendCmd("M30 "+e,"Delete file"),refreshSD()}function buildFilnames(e){filenames=e.split(/\n/g),filenames.forEach(function(e){e.match(/.gc/gi)&&"Now fresh file:"!=e.substring(0,15)&&"File opened:"!=e.substring(0,12)&&(itemHTML="<li>",itemHTML+='<span class="glyphicon glyphicon-print" aria-hidden="true" onclick="printFile(\''+e+"')\"></span>",itemHTML+='<span class="glyphicon glyphicon-trash" aria-hidden="true" onclick="deleteFile(\''+e+"')\"></span>"+e,itemHTML+="</li>",$(".sd-files ul").append(itemHTML),window.sdFilenames.push(e))})}$(document).ready(function(){printerStatus(),initWebSocket(),setTimeout(function(){startup()},2e3),setInterval(function(){printerStatus()},2e3),$(".sd-files .refresh").click(function(){$("#start_print").hasClass("btn-disable")||refreshSD()}),$(".movement .home").click(function(){axis=$(this).attr("data-axis"),"all"==axis?(code="G28 X0 Y0 Z0",comment="all axes"):(code="G28 "+axis,comment=axis+" axis"),sendCmd(code,"Home "+comment),setPositioning=!1}),$(".movement .direction button").click(function(){return command="G1 ",movement=$(this).attr("data-movement"),rate=$(".movement .rate button.active").attr("data-rate"),axis=$(this).attr("data-axis"),comment="Move "+axis,0==setPositioning&&(sendCmd("G91","Set to Relative Positioning"),setPositioning=!0),"up"!=movement&&"left"!=movement||(rate*=-1),"Z"==axis&&"down"==movement&&(comment="Raise Z "),"Z"==axis&&"up"==movement&&(comment="Lower Z "),"E"==axis&&"plus"==movement&&(comment="Extrude "),"E"==axis&&"minus"==movement?void sendCmd(command+axis+"-"+rate,"Retract "+rate+"mm"):"disable"==movement?void sendCmd("M18","Disable motor lock"):void sendCmd(command+axis+rate,comment+" "+rate+"mm")}),$(".movement .rate button").click(function(){rate=$(this).attr("data-rate"),$(".movement .rate button").removeClass("active"),$(this).addClass("active")}),$("#gCodeSend").click(function(){gCode2Send=$("#gcode").val(),""!=gCode2Send&&(sendCmd(gCode2Send,""),$("#gcode").val(""))}),$("#wre").change(function(){delaySendTemp($("#wre").val(),"extruder")}),$("#sete").click(function(){delaySendTemp($("#wre").val(),"extruder")}),$("#clre").click(function(){sendCmd("{C:T0000}","Turn off extruder preheat","cmd")}),$("#wrp").change(function(){delaySendTemp($("#wrp").val(),"platform")}),$("#setp").click(function(){delaySendTemp($("#wrp").val(),"platform")}),$("#clrp").click(function(){sendCmd("{C:P000}","Turn off platform preheat","cmd")}),$("#fanspeed").slider({min:30,max:100,value:50,reversed:!0,orientation:"vertical",formatter:function(e){return e+"%"}}),$("#fanspeed").on("slide",function(e){delaySendSpeed(e.value)}),$("#clrfan").click(function(){sendCmd("M106 S0","Turn off fan")}),$("form").submit(function(){return!1})});var timers={},setPositioning=!1,initSDCard=!1,sdListing=!1;String.prototype.contains=function(e){return this.indexOf(e)!=-1},Dropzone.options.mydz={accept:function(e,t){e.name.contains(".g")?(t(),$(".print-actions button").addClass("btn-disable"),$(".movement button").addClass("btn-disable"),$("#gCodeSend").addClass("btn-disable"),$(".temperature button").addClass("btn-disable")):t("Not a valid G-code file.")},init:function(){this.on("error",function(e,t){var n=t.errorMessage;$(e.previewElement).find(".dz-error-message").text(n)}),this.on("addedfile",function(){null!=this.files[1]&&this.removeFile(this.files[0])}),this.on("complete",function(e){$(".print-actions button").removeClass("btn-disable"),$(".movement button").removeClass("btn-disable"),$("#gCodeSend").removeClass("btn-disable"),$(".temperature button").removeClass("btn-disable"),fileParts=e.name.split("."),name=fileParts[0].substring(0,21),void 0==window.sdFilenames&&refreshSD(),window.sdFilenames.indexOf(e.name)&&sendCmd("M30 "+name+".gc","Delete old file"),setTimeout(function(){sendCmd("M566 "+name+".gc",""),refreshSD()},1e3)})}};